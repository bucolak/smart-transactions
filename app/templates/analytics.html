{% extends "base.html" %}
{% block meta_title %}Analytics Command Center{% endblock %}
{% block extra_head %}
{{ super() }}
<style>
  :root { --panel: rgba(255,255,255,0.04); --panel-border: rgba(255,255,255,0.08); --glow: rgba(37,99,235,0.35); }
  .analytics-hero { position: relative; overflow: hidden; background: radial-gradient(circle at 10% 15%, rgba(59,130,246,0.16), transparent 32%), radial-gradient(circle at 90% 10%, rgba(16,185,129,0.16), transparent 28%), #0b1224; }
  .analytics-hero::after, .analytics-hero::before { content: ""; position: absolute; width: 240px; height: 240px; border-radius: 50%; filter: blur(110px); opacity: 0.45; pointer-events: none; }
  .analytics-hero::after { background: #22c55e; top: -40px; right: -90px; }
  .analytics-hero::before { background: #2563eb; bottom: -60px; left: -80px; }
  .floating-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 42px 42px; mask-image: radial-gradient(circle at 30% 20%, rgba(0,0,0,0.5), transparent 60%); opacity: 0.6; pointer-events: none; }
  .hero-panel { border: 1px solid var(--panel-border); background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06)); border-radius: 20px; box-shadow: 0 28px 70px rgba(0,0,0,0.4); }
  .gradient-card { box-shadow: 0 24px 60px rgba(0,0,0,0.38); }
  .pill-muted { border-radius: 14px; border: 1px solid var(--panel-border); background: rgba(255,255,255,0.05); padding: 0.45rem 0.75rem; display: inline-flex; align-items: center; gap: 0.45rem; }
  .pill-muted i { color: #93c5fd; }
  .metric-chip { border: 1px solid var(--panel-border); background: rgba(255,255,255,0.03); border-radius: 16px; padding: 0.9rem 1rem; box-shadow: 0 16px 40px rgba(0,0,0,0.28); transition: transform 0.15s ease, box-shadow 0.15s ease; height: 100%; }
  .metric-chip:hover { transform: translateY(-4px); box-shadow: 0 20px 50px rgba(0,0,0,0.34); }
  .chip-label { text-transform: uppercase; letter-spacing: 0.05em; font-size: 0.8rem; color: #cbd5e1; display: flex; align-items: center; gap: 0.35rem; }
  .chip-value { font-size: 1.6rem; font-weight: 800; }
  .chip-sub { color: #94a3b8; font-size: 0.9rem; }
  .analytics-section { border: 1px solid var(--panel-border); background: var(--panel); border-radius: 18px; box-shadow: 0 18px 46px rgba(0,0,0,0.32); }
  .analytics-section .card-body { padding: 1.25rem 1.25rem 1.5rem; }
  .section-icon { width: 36px; height: 36px; border-radius: 12px; display: inline-flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.06); color: #93c5fd; box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); }
  .chart-shell { border: 1px dashed rgba(255,255,255,0.08); border-radius: 16px; padding: 0.75rem; min-height: 260px; background: rgba(255,255,255,0.02); position: relative; }
  .empty-chart { position: absolute; inset: 0; display: grid; place-items: center; color: #94a3b8; font-size: 0.95rem; text-align: center; padding: 1rem; }
  .list-tile { border: 1px solid var(--panel-border); background: rgba(255,255,255,0.02); border-radius: 16px; padding: 1rem; }
  .badge.bg-soft { border: 1px solid var(--panel-border); border-radius: 12px; }
  .stat-pill { border: 1px solid var(--panel-border); background: rgba(255,255,255,0.04); border-radius: 14px; box-shadow: 0 14px 36px rgba(0,0,0,0.28); }
  .hero-kpi { border-left: 1px solid var(--panel-border); padding-left: 1.25rem; }
  .shadow-xl { box-shadow: 0 26px 70px rgba(0,0,0,0.38) !important; }
  .btn { transition: transform 0.15s ease, box-shadow 0.15s ease; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,0.28); }
  @media (max-width: 992px) { .hero-kpi { border-left: 0; padding-left: 0; } }
</style>
{% endblock %}
{% block content %}
{% set org = data.org %}
{% set viewer = data.viewer %}
<section class="analytics-hero py-5 position-relative">
  <div class="floating-grid"></div>
  <div class="container position-relative">
    <div class="row g-4 align-items-center">
      <div class="col-lg-8">
        <div class="card shadow-xl hero-panel">
          <div class="card-body d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
            <div>
              <p class="text-uppercase text-white small mb-1">Organization Analytics</p>
              <h3 class="fw-bold text-white mb-2 d-flex align-items-center gap-2"><i class="bi bi-bezier"></i><span>{{ org.name }} · Insight Control Center</span></h3>
              <div class="text-secondary">Tenant-isolated intelligence across users, work, finance, and AI operations.</div>
              <div class="d-flex flex-wrap gap-2 mt-3">
                <span class="pill-muted"><i class="bi bi-shield-lock"></i> Isolated</span>
                <span class="pill-muted"><i class="bi bi-people"></i> {{ data.users.total }} users</span>
                <span class="pill-muted"><i class="bi bi-diagram-3"></i> {{ data.projects.count }} projects</span>
                {% if viewer.is_admin %}
                  <span class="pill-muted"><i class="bi bi-cash-stack"></i> Finance unlocked</span>
                {% else %}
                  <span class="pill-muted"><i class="bi bi-eye"></i> Limited view</span>
                {% endif %}
              </div>
            </div>
            <div class="health-score text-lg-end hero-kpi">
              <div class="badge bg-soft">Engagement index</div>
              <div class="display-5 fw-bold text-white">{{ data.health.engagement_index }}<span class="fs-5">/100</span></div>
              <div class="text-secondary small">{{ data.health.activity_window_days }}-day activity window</div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card gradient-card shadow-xl border-0 h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <p class="text-uppercase text-light small mb-1">Stability</p>
                <h5 class="fw-bold text-white text-white mb-1">Platform health</h5>
                <div class="text-light small">AI failures {{ data.health.ai_failure_rate }}% · Overdue invoices {{ data.health.overdue_invoices }}</div>
              </div>
              <span class="badge bg-light text-white">{{ viewer.role|title }}</span>
            </div>
            <div class="mt-3">
              <div class="progress rounded-pill" role="progressbar" aria-valuenow="{{ data.health.stability }}" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-gradient" style="width: {{ data.health.stability }}%"></div>
              </div>
              <div class="d-flex justify-content-between text-light small mt-2">
                <span>Stable</span>
                <span>{{ data.health.stability }}%</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<section class="analytics-body pb-5 py-5">
  <div class="container">
    <div class="row g-3 mb-4">
      <div class="col-6 col-xl-2">
        <div class="metric-chip">
          <div class="chip-label"><i class="bi bi-people"></i> Total users</div>
          <div class="chip-value">{{ data.users.total }}</div>
          <div class="chip-sub">{{ data.users.new_last_30 }} joined last 30d</div>
        </div>
      </div>
      <div class="col-6 col-xl-2">
        <div class="metric-chip">
          <div class="chip-label"><i class="bi bi-lightning-charge"></i> Active</div>
          <div class="chip-value text-success">{{ data.users.active }}</div>
          <div class="chip-sub">Verified {{ data.users.verified }}</div>
        </div>
      </div>
      <div class="col-6 col-xl-2">
        <div class="metric-chip">
          <div class="chip-label"><i class="bi bi-shield-lock"></i> Admins</div>
          <div class="chip-value">{{ data.users.admins }}</div>
          <div class="chip-sub">Members {{ data.users.members }}</div>
        </div>
      </div>
      <div class="col-6 col-xl-2">
        <div class="metric-chip">
          <div class="chip-label"><i class="bi bi-diagram-3"></i> Projects</div>
          <div class="chip-value">{{ data.projects.count }}</div>
          <div class="chip-sub">Tasks {{ data.projects.tasks }}</div>
        </div>
      </div>
      <div class="col-6 col-xl-2">
        <div class="metric-chip">
          <div class="chip-label"><i class="bi bi-stars"></i> AI calls</div>
          <div class="chip-value text-info">{{ data.ai.total }}</div>
          <div class="chip-sub">Success {{ data.ai.success }}</div>
        </div>
      </div>
      <div class="col-6 col-xl-2">
        <div class="metric-chip">
          <div class="chip-label"><i class="bi bi-hourglass-split"></i> Avg completion</div>
          <div class="chip-value">{{ data.projects.avg_completion_days }}d</div>
          <div class="chip-sub">Overdue {{ data.projects.overdue }}</div>
        </div>
      </div>
    </div>

    <div class="card analytics-section mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase text-white small mb-1">Users & Identity</p>
            <h5 class="fw-bold text-white mb-0 d-flex align-items-center gap-2"><span class="section-icon"><i class="bi bi-people"></i></span>Growth · Logins · Roles</h5>
          </div>
          <span class="badge bg-soft"><i class="bi bi-shield-check me-1"></i>Tenant-only data</span>
        </div>
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="chart-shell">
              {% set growth_empty = data.users.growth|length == 0 %}
              {% if growth_empty %}
                <div class="empty-chart">No user growth data yet.</div>
              {% endif %}
              <canvas id="userGrowth" class="{{ 'd-none' if growth_empty else '' }}" height="280"></canvas>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="chart-shell">
              {% set login_empty = data.users.login_trend|length == 0 %}
              {% if login_empty %}
                <div class="empty-chart">No login activity in the past 30 days.</div>
              {% endif %}
              <canvas id="loginTrend" class="{{ 'd-none' if login_empty else '' }}" height="280"></canvas>
            </div>
          </div>
          <div class="col-xl-4">
            <div class="chart-shell">
              {% set role_empty = data.users.roles|length == 0 %}
              {% if role_empty %}
                <div class="empty-chart">Roles will appear after members are added.</div>
              {% endif %}
              <canvas id="roleDonut" class="{{ 'd-none' if role_empty else '' }}" height="240"></canvas>
            </div>
          </div>
          <div class="col-xl-4">
            <div class="chart-shell">
              {% set admin_empty = data.users.total == 0 %}
              {% if admin_empty %}
                <div class="empty-chart">Add users to see admin/member mix.</div>
              {% endif %}
              <canvas id="adminPolar" class="{{ 'd-none' if admin_empty else '' }}" height="240"></canvas>
            </div>
          </div>
          <div class="col-xl-4">
            <div class="list-tile h-100">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="fw-semibold text-white mb-0">Recent logins</h6>
                <span class="badge bg-soft">Last seen</span>
              </div>
              {% if data.users.top_logins|length == 0 %}
                <div class="text-secondary small">No login events yet.</div>
              {% else %}
                <ul class="list-unstyled mb-0 small">
                  {% for user in data.users.top_logins %}
                    <li class="d-flex justify-content-between align-items-center py-1">
                      <div class="text-white">{{ user.name }}</div>
                      <span class="text-secondary">{{ user.last_login or '—' }}</span>
                    </li>
                  {% endfor %}
                </ul>
              {% endif %}
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card analytics-section mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase text-white small mb-1">Work Execution</p>
            <h5 class="fw-bold text-white mb-0 d-flex align-items-center gap-2"><span class="section-icon"><i class="bi bi-kanban"></i></span>Projects · Tasks · Productivity</h5>
          </div>
          <span class="badge bg-soft"><i class="bi bi-briefcase me-1"></i>Real tasks only</span>
        </div>
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="chart-shell">
              {% set status_empty = data.projects.status|length == 0 %}
              {% if status_empty %}
                <div class="empty-chart">No tasks yet.</div>
              {% endif %}
              <canvas id="taskStatus" class="{{ 'd-none' if status_empty else '' }}" height="260"></canvas>
            </div>
          </div>
          <div class="col-lg-6">
            <div class="chart-shell">
              {% set priority_empty = data.projects.priority|length == 0 %}
              {% if priority_empty %}
                <div class="empty-chart">No task priority data.</div>
              {% endif %}
              <canvas id="priorityRadar" class="{{ 'd-none' if priority_empty else '' }}" height="260"></canvas>
            </div>
          </div>
          <div class="col-xl-6">
            <div class="chart-shell">
              {% set completion_empty = data.projects.completion_trend|length == 0 %}
              {% if completion_empty %}
                <div class="empty-chart">No completed tasks in the last 90 days.</div>
              {% endif %}
              <canvas id="completionTrend" class="{{ 'd-none' if completion_empty else '' }}" height="260"></canvas>
            </div>
          </div>
          <div class="col-xl-6">
            <div class="chart-shell">
              {% set creation_empty = data.projects.creation_trend|length == 0 %}
              {% if creation_empty %}
                <div class="empty-chart">No task creation in the last 30 days.</div>
              {% endif %}
              <canvas id="creationTrend" class="{{ 'd-none' if creation_empty else '' }}" height="260"></canvas>
            </div>
          </div>
          <div class="col-xl-6">
            <div class="chart-shell">
              {% set per_user_empty = data.projects.tasks_per_user|length == 0 %}
              {% if per_user_empty %}
                <div class="empty-chart">Assign tasks to see distribution.</div>
              {% endif %}
              <canvas id="tasksPerUser" class="{{ 'd-none' if per_user_empty else '' }}" height="260"></canvas>
            </div>
          </div>
          <div class="col-xl-6">
            <div class="chart-shell">
              {% set load_empty = data.projects.project_load|length == 0 %}
              {% if load_empty %}
                <div class="empty-chart">Create projects to view workload.</div>
              {% endif %}
              <canvas id="projectLoad" class="{{ 'd-none' if load_empty else '' }}" height="260"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if data.finance.visible %}
    <div class="card analytics-section mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase text-white small mb-1">Finance & Billing (Admin)</p>
            <h5 class="fw-bold text-white mb-0 d-flex align-items-center gap-2"><span class="section-icon"><i class="bi bi-currency-dollar"></i></span>Revenue · Status · Payments</h5>
          </div>
          <span class="badge bg-soft text-success"><i class="bi bi-lock me-1"></i> Admin only</span>
        </div>
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="chart-shell">
              {% set revenue_empty = data.finance.monthly|length == 0 %}
              {% if revenue_empty %}
                <div class="empty-chart">No invoice history yet.</div>
              {% endif %}
              <canvas id="revenueTrend" class="{{ 'd-none' if revenue_empty else '' }}" height="260"></canvas>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="chart-shell">
              {% set invoice_empty = data.finance.status_totals|length == 0 %}
              {% if invoice_empty %}
                <div class="empty-chart">No invoices created.</div>
              {% endif %}
              <canvas id="invoiceStatus" class="{{ 'd-none' if invoice_empty else '' }}" height="240"></canvas>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="chart-shell">
              {% set payment_empty = data.finance.payments|length == 0 %}
              {% if payment_empty %}
                <div class="empty-chart">No payments processed.</div>
              {% endif %}
              <canvas id="paymentStatus" class="{{ 'd-none' if payment_empty else '' }}" height="240"></canvas>
            </div>
          </div>
          <div class="col-12">
            <div class="stat-pill d-flex justify-content-between align-items-center">
              <div>
                <div class="text-white text-uppercase small">Total billed</div>
                <div class="fw-bold text-white">${{ '%.2f'|format(data.finance.total_billed) }}</div>
              </div>
              <div class="text-secondary">Invoices: {{ data.finance.invoice_count }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}

    <div class="card analytics-section mb-4">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase text-white small mb-1">AI Operations</p>
            <h5 class="fw-bold text-white mb-0 d-flex align-items-center gap-2"><span class="section-icon"><i class="bi bi-cpu"></i></span>Usage · Outcomes · Power users</h5>
          </div>
          <span class="badge bg-soft text-info"><i class="bi bi-stars me-1"></i>Ready for AI insights</span>
        </div>
        <div class="row g-3">
          <div class="col-lg-6">
            <div class="chart-shell">
              {% set ai_usage_empty = data.ai.usage_trend|length == 0 %}
              {% if ai_usage_empty %}
                <div class="empty-chart">No AI interactions in the last 30 days.</div>
              {% endif %}
              <canvas id="aiUsage" class="{{ 'd-none' if ai_usage_empty else '' }}" height="260"></canvas>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="chart-shell">
              {% set ai_outcome_empty = data.ai.total == 0 %}
              {% if ai_outcome_empty %}
                <div class="empty-chart">No AI outcomes yet.</div>
              {% endif %}
              <canvas id="aiOutcome" class="{{ 'd-none' if ai_outcome_empty else '' }}" height="240"></canvas>
            </div>
          </div>
          <div class="col-lg-3">
            <div class="chart-shell">
              {% set ai_op_empty = data.ai.operations|length == 0 %}
              {% if ai_op_empty %}
                <div class="empty-chart">No AI operation breakdown.</div>
              {% endif %}
              <canvas id="aiRadar" class="{{ 'd-none' if ai_op_empty else '' }}" height="240"></canvas>
            </div>
          </div>
          <div class="col-12">
            <div class="chart-shell">
              {% set ai_users_empty = data.ai.users|length == 0 %}
              {% if ai_users_empty %}
                <div class="empty-chart">No AI-active users yet.</div>
              {% endif %}
              <canvas id="aiUsers" class="{{ 'd-none' if ai_users_empty else '' }}" height="260"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card analytics-section">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <div>
            <p class="text-uppercase text-white small mb-1">Resilience & Future AI</p>
            <h5 class="fw-bold text-white mb-0 d-flex align-items-center gap-2"><span class="section-icon"><i class="bi bi-shield-check"></i></span>Engagement · Stability · AI-ready</h5>
          </div>
          <span class="badge bg-soft"><i class="bi bi-rocket"></i> Future AI insights panel ready</span>
        </div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="chart-shell">
              <canvas id="engagementGauge" height="220"></canvas>
            </div>
          </div>
          <div class="col-md-6">
            <div class="chart-shell">
              <canvas id="stabilityGauge" height="220"></canvas>
            </div>
          </div>
        </div>
        <div class="alert alert-dark-soft mt-3 mb-0" role="alert">
          Future AI auto-insights can plug in here to narrate trends, call out anomalies, and recommend admin actions without changing this layout.
        </div>
      </div>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" ></script>
  <script>
    const analytics = {{ data | tojson }};
    const normalizeHex = (value, fallback) => {
      if (typeof value !== 'string') return fallback;
      const normalized = value.trim();
      return /^#([0-9a-fA-F]{6})$/.test(normalized) ? normalized : fallback;
    };
    const brand = normalizeHex(analytics?.org?.brand_color, '#2563eb');
    const neutral = '#94a3b8';
    const muted = '#1f2937';

    const toRgba = (hex, alpha = 1) => {
      const match = /^#?([a-fA-F0-9]{6})$/.exec(hex || '');
      if (!match) return `rgba(37, 99, 235, ${alpha})`;
      const intVal = parseInt(match[1], 16);
      const r = (intVal >> 16) & 255;
      const g = (intVal >> 8) & 255;
      const b = intVal & 255;
      return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    };

    const gradient = (ctx) => {
      const g = ctx.createLinearGradient(0, 0, 0, 260);
      g.addColorStop(0, toRgba(brand, 0.8));
      g.addColorStop(1, toRgba(brand, 0));
      return g;
    };

    const safeChart = (id, render) => {
      try {
        render();
      } catch (err) {
        console.error(`Analytics chart error (${id})`, err);
      }
    };

    const buildLine = (id, labels, dataPoints, opts = {}) => {
      const el = document.getElementById(id);
      if (!el || !labels || !dataPoints) return;
      safeChart(id, () => {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'line',
          data: {
            labels,
            datasets: [
              {
                data: dataPoints,
                label: opts.label || 'Value',
                borderColor: opts.color || brand,
                backgroundColor: opts.fill ? gradient(ctx) : 'transparent',
                fill: !!opts.fill,
                tension: 0.35,
                borderWidth: 3,
                pointRadius: 0,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: !!opts.showLegend } },
            scales: {
              x: { ticks: { color: neutral } },
              y: { ticks: { color: neutral }, beginAtZero: true },
            },
          },
        });
      });
    };

    const buildBar = (id, labels, datasets, opts = {}) => {
      const el = document.getElementById(id);
      if (!el || !labels || !datasets) return;
      safeChart(id, () => {
        const ctx = el.getContext('2d');
        new Chart(ctx, {
          type: 'bar',
          data: { labels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            indexAxis: opts.horizontal ? 'y' : 'x',
            plugins: { legend: { display: !!opts.showLegend }, tooltip: { mode: 'index', intersect: false } },
            scales: {
              x: { stacked: !!opts.stacked, ticks: { color: neutral } },
              y: { stacked: !!opts.stacked, ticks: { color: neutral }, beginAtZero: true },
            },
          },
        });
      });
    };

    const buildDoughnut = (id, labels, dataPoints, colors) => {
      const el = document.getElementById(id);
      if (!el || !labels || !dataPoints || !colors) return;
      safeChart(id, () => {
        new Chart(el, {
          type: 'doughnut',
          data: {
            labels,
            datasets: [
              {
                data: dataPoints,
                backgroundColor: colors,
                borderWidth: 0,
              },
            ],
          },
          options: {
            cutout: '65%',
            plugins: { legend: { position: 'bottom', labels: { color: neutral } } },
          },
        });
      });
    };

    const buildPolar = (id, labels, dataPoints, colors) => {
      const el = document.getElementById(id);
      if (!el || !labels || !dataPoints || !colors) return;
      safeChart(id, () => {
        new Chart(el, {
          type: 'polarArea',
          data: {
            labels,
            datasets: [
              {
                data: dataPoints,
                backgroundColor: colors,
                borderWidth: 0,
              },
            ],
          },
          options: {
            scales: { r: { ticks: { display: false } } },
            plugins: { legend: { position: 'bottom', labels: { color: neutral } } },
          },
        });
      });
    };

    const buildRadar = (id, labels, dataPoints) => {
      const el = document.getElementById(id);
      if (!el || !labels || !dataPoints) return;
      safeChart(id, () => {
        new Chart(el, {
          type: 'radar',
          data: {
            labels,
            datasets: [
              {
                data: dataPoints,
                label: 'Coverage',
                backgroundColor: toRgba(brand, 0.2),
                borderColor: brand,
                pointBackgroundColor: brand,
              },
            ],
          },
          options: {
            scales: { r: { angleLines: { color: muted }, grid: { color: '#1f2937' }, ticks: { showLabelBackdrop: false } } },
            plugins: { legend: { display: false } },
          },
        });
      });
    };

    const userGrowth = analytics.users.growth || [];
    if (userGrowth.length) {
      buildLine('userGrowth', userGrowth.map((p) => p.label), userGrowth.map((p) => p.value), { fill: true, label: 'Users' });
    }

    const loginTrend = analytics.users.login_trend || [];
    if (loginTrend.length) {
      buildBar('loginTrend', loginTrend.map((p) => p.label), [
        {
          label: 'Logins',
          data: loginTrend.map((p) => p.value),
          backgroundColor: brand,
          borderRadius: 10,
          maxBarThickness: 22,
        },
      ]);
    }

    const roles = analytics.users.roles || [];
    if (roles.length) {
      buildDoughnut('roleDonut', roles.map((r) => r.role === 'admin' ? 'Admin' : 'Standard'), roles.map((r) => r.count), [brand, '#22c55e']);
    }

    if (analytics.users.total) {
      buildPolar('adminPolar', ['Admins', 'Members'], [analytics.users.admins, analytics.users.members], [brand, '#f97316']);
    }

    const statusData = analytics.projects.status || [];
    if (statusData.length) {
      buildBar('taskStatus', statusData.map((s) => s.status.replace('_', ' ').toUpperCase()), [
        {
          label: 'Tasks',
          data: statusData.map((s) => s.count),
          backgroundColor: [brand, '#f59e0b', '#22c55e', '#ef4444'],
          borderRadius: 8,
        },
      ], { stacked: true });
    }

    const priorityData = analytics.projects.priority || [];
    if (priorityData.length) {
      buildRadar('priorityRadar', priorityData.map((p) => p.priority.toUpperCase()), priorityData.map((p) => p.count));
    }

    const completionTrend = analytics.projects.completion_trend || [];
    if (completionTrend.length) {
      buildLine('completionTrend', completionTrend.map((p) => p.label), completionTrend.map((p) => p.value), { fill: true, label: 'Completed' });
    }

    const creationTrend = analytics.projects.creation_trend || [];
    if (creationTrend.length) {
      buildLine('creationTrend', creationTrend.map((p) => p.label), creationTrend.map((p) => p.value), { fill: true, color: '#22c55e', label: 'Created' });
    }

    const tasksPerUser = analytics.projects.tasks_per_user || [];
    if (tasksPerUser.length) {
      buildBar('tasksPerUser', tasksPerUser.map((p) => p.name), [
        {
          label: 'Tasks',
          data: tasksPerUser.map((p) => p.count),
          backgroundColor: '#22c55e',
          borderRadius: 10,
        },
      ], { horizontal: true });
    }

    const projectLoad = analytics.projects.project_load || [];
    if (projectLoad.length) {
      buildBar('projectLoad', projectLoad.map((p) => p.project), [
        {
          label: 'Tasks',
          data: projectLoad.map((p) => p.count),
          backgroundColor: '#6366f1',
          borderRadius: 8,
        },
      ], { horizontal: true });
    }

    if (analytics.finance && analytics.finance.visible) {
      const revenue = analytics.finance.monthly || [];
      if (revenue.length) {
        buildLine('revenueTrend', revenue.map((p) => p.label), revenue.map((p) => p.value), { fill: true, label: 'Revenue', color: '#a855f7' });
      }

      const invoiceStatus = analytics.finance.status_totals || [];
      if (invoiceStatus.length) {
        buildDoughnut('invoiceStatus', invoiceStatus.map((i) => i.status.toUpperCase()), invoiceStatus.map((i) => i.amount), ['#22c55e', '#f59e0b', '#ef4444']);
      }

      const paymentStatus = analytics.finance.payments || [];
      if (paymentStatus.length) {
        buildBar('paymentStatus', paymentStatus.map((p) => p.status.toUpperCase()), [
          {
            label: 'Payments',
            data: paymentStatus.map((p) => p.count),
            backgroundColor: ['#22c55e', '#f59e0b', '#ef4444'],
            borderRadius: 10,
          },
        ]);
      }
    }

    const aiUsage = analytics.ai.usage_trend || [];
    if (aiUsage.length) {
      buildLine('aiUsage', aiUsage.map((p) => p.label), aiUsage.map((p) => p.value), { fill: true, label: 'AI calls', color: '#0ea5e9' });
    }

    if (analytics.ai.total) {
      buildDoughnut('aiOutcome', ['Success', 'Failed'], [analytics.ai.success, analytics.ai.failed], ['#22c55e', '#ef4444']);
    }

    const aiOps = analytics.ai.operations || [];
    if (aiOps.length) {
      buildRadar('aiRadar', aiOps.map((o) => o.operation), aiOps.map((o) => o.count));
    }

    const aiUsers = analytics.ai.users || [];
    if (aiUsers.length) {
      buildBar('aiUsers', aiUsers.map((u) => u.name), [
        {
          label: 'AI calls',
          data: aiUsers.map((u) => u.count),
          backgroundColor: '#0ea5e9',
          borderRadius: 10,
        },
      ], { horizontal: true });
    }

    const gauge = (id, value, color) => {
      const el = document.getElementById(id);
      if (!el) return;
      new Chart(el, {
        type: 'doughnut',
        data: {
          labels: ['Score', 'Remaining'],
          datasets: [
            {
              data: [value, Math.max(0, 100 - value)],
              backgroundColor: [color, '#1f2937'],
              borderWidth: 0,
            },
          ],
        },
        options: {
          cutout: '80%',
          rotation: -90,
          circumference: 180,
          plugins: { legend: { display: false }, tooltip: { enabled: false } },
        },
      });
    };

    gauge('engagementGauge', analytics.health.engagement_index || 0, brand);
    gauge('stabilityGauge', analytics.health.stability || 0, '#22c55e');
  </script>
{% endblock %}
