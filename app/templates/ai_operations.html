{% extends "base.html" %}
{% block content %}
<section class="py-4 dashboard">
  <div class="container">
    <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-4">
      <div>
        <p class="text-uppercase text-muted small mb-1">AI Operations</p>
        <h3 class="fw-bold mb-0">Monitoring & Activity</h3>
        <div class="text-secondary small">Track Gemini usage, status, and tenant-scoped AI events.</div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <span class="badge bg-primary-subtle text-primary"><i class="bi bi-cpu me-1"></i>{{ current_org.name }}</span>
        <span class="badge bg-success-subtle text-success"><i class="bi bi-shield-lock me-1"></i>Isolated</span>
      </div>
    </div>

    <div class="row g-3 mb-4">
      <div class="col-12 col-md-4 col-xl-3">
        <div class="stat-card h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase text-muted small mb-1">Logs</p>
              <div class="stat-number">{{ logs|length }}</div>
            </div>
            <div class="icon-circle text-info"><i class="bi bi-activity"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4 col-xl-3">
        <div class="stat-card h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase text-muted small mb-1">Success</p>
              <div class="stat-number text-success">{{ logs | selectattr('status', 'equalto', AIStatus.SUCCESS) | list | length }}</div>
            </div>
            <div class="icon-circle text-success"><i class="bi bi-check2-circle"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-md-4 col-xl-3">
        <div class="stat-card h-100">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <p class="text-uppercase text-muted small mb-1">Failures</p>
              <div class="stat-number text-danger">{{ logs | selectattr('status', 'equalto', AIStatus.FAILED) | list | length }}</div>
            </div>
            <div class="icon-circle text-danger"><i class="bi bi-bug"></i></div>
          </div>
        </div>
      </div>
      <div class="col-12 col-xl-3">
        <div class="card mini-card h-100">
          <div class="card-body d-flex justify-content-between align-items-center">
            <div>
              <div class="fw-semibold">Trigger check</div>
              <div class="text-secondary small">Gemini response stored</div>
            </div>
            <form method="post" action="{{ url_for('main.trigger_ai_health') }}">
              <button class="btn btn-primary btn-sm" type="submit"><i class="bi bi-magic"></i> Run</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-7">
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
              <div>
                <p class="text-uppercase text-muted small mb-1">Filters</p>
                <h5 class="fw-bold mb-0">Scope activity</h5>
              </div>
            </div>
            <form class="row g-3" method="get">
              <div class="col-md-3">
                <label class="form-label" for="status">Status</label>
                <select class="form-select" id="status" name="status">
                  <option value="">Any</option>
                  {% for status in AIStatus %}
                    <option value="{{ status.value }}" {% if request.args.get('status') == status.value %}selected{% endif %}>{{ status.value | title }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label" for="user_id">User</label>
                <select class="form-select" id="user_id" name="user_id">
                  <option value="">Any</option>
                  {% for teammate in teammates %}
                    <option value="{{ teammate.id }}" {% if request.args.get('user_id') == teammate.id|string %}selected{% endif %}>{{ teammate.full_name }}</option>
                  {% endfor %}
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label" for="start">Start</label>
                <input class="form-control" type="date" id="start" name="start" value="{{ request.args.get('start', '') }}">
              </div>
              <div class="col-md-3">
                <label class="form-label" for="end">End</label>
                <input class="form-control" type="date" id="end" name="end" value="{{ request.args.get('end', '') }}">
              </div>
              <div class="col-12 d-flex gap-2 justify-content-end">
                <a href="{{ url_for('main.ai_operations') }}" class="btn btn-outline-light">Reset</a>
                <button type="submit" class="btn btn-primary">Apply</button>
              </div>
            </form>
          </div>
        </div>

        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3 mb-3">
              <div>
                <p class="text-uppercase text-muted small mb-1">Events</p>
                <h5 class="fw-bold mb-0">AI activity log</h5>
              </div>
              <div class="text-secondary small">{{ logs|length }} record{{ '' if logs|length == 1 else 's' }}</div>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-hover align-middle mb-0">
                <thead>
                  <tr>
                    <th>Operation</th>
                    <th>Status</th>
                    <th>User</th>
                    <th>When</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for log in logs %}
                  <tr>
                    <td>
                      <div class="fw-semibold">{{ log.operation_name }}</div>
                      <div class="text-secondary small text-wrap" style="max-width: 320px;">{{ (log.result_summary or log.context or '')[:120] }}{% if log.result_summary and log.result_summary|length > 120 %}...{% endif %}</div>
                    </td>
                    <td>
                      {% set badge_class = 'bg-soft' %}
                      {% if log.status == AIStatus.SUCCESS %}
                        {% set badge_class = 'bg-success-subtle text-success' %}
                      {% elif log.status == AIStatus.FAILED %}
                        {% set badge_class = 'bg-danger text-white' %}
                      {% elif log.status == AIStatus.PENDING %}
                        {% set badge_class = 'bg-warning text-dark' %}
                      {% endif %}
                      <span class="badge {{ badge_class }}">{{ log.status.value | title }}</span>
                    </td>
                    <td class="text-secondary small">{{ log.triggered_by.full_name if log.triggered_by else 'System' }}</td>
                    <td class="text-secondary small">{{ log.created_at.strftime('%b %d, %Y %H:%M') }}</td>
                    <td class="text-end">
                      {% if can_admin %}
                      <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#editLogModal" data-log-id="{{ log.id }}" data-log-status="{{ log.status.value }}" data-log-summary="{{ log.result_summary or '' }}">
                        <i class="bi bi-pencil"></i>
                      </button>
                      <form method="post" action="{{ url_for('main.delete_ai_log', log_id=log.id) }}" class="d-inline" onsubmit="return confirm('Delete this log?');">
                        <button type="submit" class="btn btn-sm btn-outline-danger"><i class="bi bi-trash"></i></button>
                      </form>
                      {% else %}
                      <span class="badge bg-secondary">View</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr><td colspan="5" class="text-center text-secondary py-4">No AI events recorded yet.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
      <div class="col-lg-5">
        <div class="card border-0 shadow-sm mb-3">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold mb-0">Usage over time</h6>
              <span class="badge bg-soft">Requests</span>
            </div>
            <canvas id="aiUsageChart" height="260"></canvas>
          </div>
        </div>
        <div class="card border-0 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold mb-0">Top operations</h6>
              <span class="badge bg-soft">Frequency</span>
            </div>
            <canvas id="aiOpsChart" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

{% if can_admin %}
<div class="modal fade" id="editLogModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content bg-dark border-0">
      <form method="post" id="editLogForm">
        <div class="modal-header border-0">
          <div>
            <p class="text-uppercase text-muted small mb-1">Edit log</p>
            <h5 class="fw-bold mb-0">Update status</h5>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label" for="edit_log_status">Status</label>
            <select class="form-select" id="edit_log_status" name="status">
              {% for status in AIStatus %}
                <option value="{{ status.value }}">{{ status.value | title }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label" for="edit_log_summary">Result summary</label>
            <textarea class="form-control" id="edit_log_summary" name="result_summary" rows="3"></textarea>
          </div>
        </div>
        <div class="modal-footer border-0">
          <button type="button" class="btn btn-outline-light" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Save</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" integrity="sha384-CbCmfkWFKmWgS1dVgPY9c7/qlTLX7sD6gyHaZ/0/ynRF/oU1jPQnF7tfhFJlu6Jv" crossorigin="anonymous"></script>
<script>
  const usageTrend = {{ usage_trend | tojson }};
  const opBreakdown = {{ op_breakdown | tojson }};
  const brand = getComputedStyle(document.documentElement).getPropertyValue('--brand-color') || '#2563eb';

  const usageCtx = document.getElementById('aiUsageChart');
  if (usageCtx) {
    new Chart(usageCtx.getContext('2d'), {
      type: 'line',
      data: {
        labels: usageTrend.map((p) => p.label),
        datasets: [{
          label: 'Requests',
          data: usageTrend.map((p) => p.value),
          borderColor: brand,
          backgroundColor: brand + '33',
          fill: true,
          tension: 0.35,
        }],
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } },
    });
  }

  const opsCtx = document.getElementById('aiOpsChart');
  if (opsCtx) {
    new Chart(opsCtx.getContext('2d'), {
      type: 'bar',
      data: {
        labels: opBreakdown.map((p) => p.operation),
        datasets: [{
          label: 'Count',
          data: opBreakdown.map((p) => p.count),
          backgroundColor: brand,
          borderRadius: 8,
        }],
      },
      options: { plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } },
    });
  }

  const editLogModal = document.getElementById('editLogModal');
  const editLogForm = document.getElementById('editLogForm');
  editLogModal?.addEventListener('show.bs.modal', (event) => {
    const trigger = event.relatedTarget;
    if (!trigger) return;
    const id = trigger.getAttribute('data-log-id');
    editLogForm?.setAttribute('action', `/ai/operations/${id}/update`);
    editLogForm.querySelector('#edit_log_status').value = trigger.getAttribute('data-log-status') || 'pending';
    editLogForm.querySelector('#edit_log_summary').value = trigger.getAttribute('data-log-summary') || '';
  });
</script>
{% endblock %}
