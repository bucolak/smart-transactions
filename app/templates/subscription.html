{% extends "base.html" %}
{% block extra_head %}
  {% if razorpay_key_id %}
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  {% endif %}
{% endblock %}
{% block content %}
<section class="subscription-hero position-relative overflow-hidden py-5">
  <div class="orb orb-left"></div>
  <div class="orb orb-right"></div>
  <div class="container">
    <div class="d-flex flex-column flex-lg-row align-items-start align-items-lg-center justify-content-between gap-3 mb-4">
      <div>
        <span class="section-label"><i class="bi bi-credit-card-2-front me-2"></i>Subscription</span>
        <h2 class="fw-bold text-white text-white mb-1">Billing & licensing</h2>
        <div class="text-secondary">Real SaaS capacity gating with Stripe and Razorpay.</div>
      </div>
      <div class="d-flex flex-wrap gap-2">
        <span class="pill-muted"><i class="bi bi-building me-2"></i>{{ current_org.name }}</span>
        <span class="pill-muted"><i class="bi bi-shield-lock me-2"></i>Tenant isolated</span>
        <span class="pill-muted"><i class="bi bi-graph-up-arrow me-2"></i>Usage-aware</span>
      </div>
    </div>

    {% set allowed = subscription.allowed_member_limit %}
    {% set used = subscription.current_member_count %}
    {% set remaining = remaining_seats %}
    <div class="card border-0 shadow-xl mb-4 bg-surface card-lift">
      <div class="card-body">
        <div class="d-flex flex-column flex-lg-row justify-content-between align-items-start gap-3">
          <div class="w-100">
            <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
              <span class="section-label"><i class="bi bi-activity me-2"></i>Current status</span>
              <span class="badge bg-dark text-white text-uppercase">{{ subscription.status.value.replace('_', ' ') }}</span>
            </div>
            <div class="d-flex align-items-center gap-3 flex-wrap">
              <div class="stat-chip">
                <div class="fw-bold text-white text-white">{{ used }} / {{ allowed }}</div>
                <div class="text-secondary small">Members in plan</div>
              </div>
              <div class="stat-chip">
                <div class="fw-bold text-white text-white">{{ remaining }}</div>
                <div class="text-secondary small">Seats remaining</div>
              </div>
              <div class="stat-chip">
                <div class="fw-bold text-white text-white">{{ pricing.base_fee }} {{ pricing.currency }}</div>
                <div class="text-secondary small">Base fee + per member</div>
              </div>
            </div>
            <div class="text-secondary small mt-3">
              {% if subscription.status == SubscriptionStatus.TRIAL %}
                Trial is active for {{ subscription.trial_member_limit }} members. Upgrade to expand capacity.
              {% elif subscription.status == SubscriptionStatus.ACTIVE %}
                Active subscription via {{ subscription.payment_provider.value if subscription.payment_provider else 'N/A' }}.
              {% else %}
                Subscription requires attention. Upgrade to restore capacity.
              {% endif %}
            </div>
            <div class="progress progress-thick mt-3">
              {% set pct = (used / allowed * 100) if allowed > 0 else 0 %}
              <div class="progress-bar bg-gradient" role="progressbar" style="width: {{ pct }}%" aria-valuenow="{{ pct }}" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 bg-surface card-lift">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <span class="section-label"><i class="bi bi-arrow-up-right-circle me-2"></i>Upgrade</span>
                <h6 class="fw-bold text-white mb-0">Buy member capacity</h6>
              </div>
              <span class="badge bg-soft">Secure checkout</span>
            </div>
            <form method="post" action="{{ url_for('main.subscription_checkout') }}" class="upgrade-form">
              <div class="mb-3">
                <label class="form-label text-white" for="member_limit">Total members you want to allow</label>
                <input class="form-control" type="number" min="6" id="member_limit" name="member_limit" placeholder="e.g. 50" required>
                <div class="form-text text-white">You pay base fee + per member pricing for this total capacity.</div>
              </div>
              <div class="mb-3">
                <label class="form-label text-white" for="country">Customer country (for provider selection)</label>
                <input class="form-control" type="text" id="country" name="country" placeholder="US, IN, ...">
              </div>
              <div class="mb-3">
                <label class="form-label text-white">Payment provider</label>
                <div class="d-flex flex-wrap gap-3">
                  <label class="provider-pill form-check d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="provider" id="providerStripe" value="stripe" checked>
                    <span class="fw-semibold text-white">Stripe</span>
                  </label>
                  <label class="provider-pill form-check d-flex align-items-center gap-2">
                    <input class="form-check-input" type="radio" name="provider" id="providerRazorpay" value="razorpay">
                    <span class="fw-semibold text-white"><i class="bi bi-lightning-charge"></i> Razorpay</span>
                  </label>
                </div>
                <div class="form-text text-white">Stripe serves global customers; Razorpay is preferred for India.</div>
              </div>
              <div class="alert alert-info small">
                Billing formula: Base {{ pricing.base_fee }} + (Members × {{ pricing.per_member_fee }}). Example 50 seats: {{ pricing.base_fee + pricing.per_member_fee*50 }} {{ pricing.currency }}.
              </div>
              <div class="d-flex flex-wrap gap-2">
                <button type="submit" class="btn btn-primary"><i class="bi bi-credit-card"></i> Pay with Stripe</button>
                <button type="submit" class="btn btn-outline-light" onclick="document.getElementById('providerRazorpay').checked = true;"><i class="bi bi-lightning"></i> Pay with Razorpay</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <div class="col-lg-6">
        <div class="card border-0 shadow-lg h-100 bg-surface card-lift">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <span class="section-label"><i class="bi bi-receipt me-2"></i>Transactions</span>
                <h6 class="fw-bold text-white mb-0">Payment history</h6>
              </div>
              <span class="badge bg-soft">Admin only</span>
            </div>
            <div class="table-responsive">
              <table class="table table-dark table-sm align-middle mb-0">
                <thead>
                  <tr>
                    <th>Date</th>
                    <th>Provider</th>
                    <th>Status</th>
                    <th>Amount</th>
                    <th>Members</th>
                    <th>Txn ID</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  {% for txn in transactions %}
                  <tr>
                    <td class="text-secondary small">{{ txn.created_at.strftime('%b %d, %Y') }}</td>
                    <td>{{ txn.provider.value | title }}</td>
                    <td>
                      {% if txn.status.value == 'succeeded' %}
                        <span class="badge bg-success-subtle text-success">Succeeded</span>
                      {% elif txn.status.value == 'pending' %}
                        <span class="badge bg-warning text-dark">Pending</span>
                      {% else %}
                        <span class="badge bg-danger">Failed</span>
                      {% endif %}
                    </td>
                    <td class="fw-semibold text-white">{{ txn.amount }} <span class="text-secondary small">{{ txn.currency }}</span></td>
                    <td>{{ txn.member_limit }}</td>
                    <td class="text-secondary small">{{ txn.provider_payment_id or txn.provider_order_id or '—' }}</td>
                    <td>
                      {% if txn.status == PaymentStatus.PENDING %}
                        <form method="post" action="{{ url_for('main.subscription_retry', txn_id=txn.id) }}" class="d-inline">
                          <button type="submit" class="btn btn-sm btn-outline-warning">Retry payment</button>
                        </form>
                      {% else %}
                        <span class="text-secondary small">—</span>
                      {% endif %}
                    </td>
                  </tr>
                  {% else %}
                  <tr><td colspan="7" class="text-center text-secondary py-3">No payments yet.</td></tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    {% if razorpay_order %}
    <div class="alert alert-warning mt-4"><i class="bi bi-lightning-charge"></i> Razorpay order ready. Click "Pay with Razorpay" to open checkout.</div>
    {% endif %}
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
{{ super() }}
<script src="{{ url_for('static', filename='js/button_spinner.js') }}"></script>
{% if razorpay_order %}
<script>
  const razorpayOptions = {
    key: '{{ razorpay_order.key_id }}',
    amount: '{{ razorpay_order.amount }}',
    currency: '{{ razorpay_order.currency }}',
    name: '{{ current_org.name }} Subscription',
    order_id: '{{ razorpay_order.order_id }}',
    description: 'Subscription capacity purchase',
    handler: function (response) {
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '{{ url_for('main.verify_razorpay') }}';
      form.innerHTML = `
        <input type="hidden" name="razorpay_payment_id" value="${response.razorpay_payment_id}" />
        <input type="hidden" name="razorpay_order_id" value="${response.razorpay_order_id}" />
        <input type="hidden" name="razorpay_signature" value="${response.razorpay_signature}" />
      `;
      document.body.appendChild(form);
      form.submit();
    },
    prefill: {
      email: '{{ current_user.email }}',
      name: '{{ current_user.full_name }}'
    },
    theme: { color: '{{ brand_color() }}' }
  };
  const rz = new Razorpay(razorpayOptions);
  rz.open();
</script>
{% endif %}
{% endblock %}
