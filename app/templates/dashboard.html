{% extends "base.html" %}
{% set data = dashboard_data %}
{% block extra_head %}
{{ super() }}
<style>
  :root { --panel: rgba(255,255,255,0.04); --panel-border: rgba(255,255,255,0.08); }
  .dashboard-shell { position: relative; overflow: hidden; }
  .dashboard-shell::after, .dashboard-shell::before { content: ""; position: absolute; width: 240px; height: 240px; border-radius: 50%; filter: blur(110px); opacity: 0.4; pointer-events: none; }
  .dashboard-shell::after { background: {{ brand_color()|tojson }}; top: -60px; right: -80px; }
  .dashboard-shell::before { background: #22c55e; bottom: -80px; left: -90px; }
  .floating-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px); background-size: 44px 44px; mask-image: radial-gradient(circle at 30% 20%, rgba(0,0,0,0.35), transparent 60%); opacity: 0.55; pointer-events: none; }
  .dashboard-hero { background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.07)); border: 1px solid var(--panel-border); border-radius: 20px; box-shadow: 0 26px 70px rgba(0,0,0,0.38); position: relative; overflow: hidden; }
  .dashboard-hero::after { content: ""; position: absolute; inset: 0; background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.06), transparent 35%), radial-gradient(circle at 80% 0, rgba(255,255,255,0.08), transparent 30%); pointer-events: none; }
  .stat-card, .mini-card, .admin-quick, .chart-card, .ai-card { border: 1px solid var(--panel-border); background: rgba(255,255,255,0.03); border-radius: 18px; box-shadow: 0 18px 46px rgba(0,0,0,0.32); transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease; }
  .stat-card:hover, .mini-card:hover, .admin-quick:hover, .chart-card:hover, .ai-card:hover { transform: translateY(-3px); box-shadow: 0 22px 54px rgba(0,0,0,0.36); border-color: rgba(96,165,250,0.35); }
  .stat-number { font-size: 1.7rem; font-weight: 800; }
  .chart-shell { border: 1px dashed rgba(255,255,255,0.12); border-radius: 16px; padding: 0.75rem; min-height: 240px; background: rgba(255,255,255,0.02); position: relative; }
  .empty-chart { position: absolute; inset: 0; display: grid; place-items: center; color: #94a3b8; font-size: 0.95rem; text-align: center; padding: 1rem; }
  .quick-tile { display: block; padding: 1rem; border: 1px solid var(--panel-border); border-radius: 16px; background: rgba(255,255,255,0.02); text-decoration: none; color: inherit; transition: transform 0.16s ease, box-shadow 0.16s ease, border-color 0.16s ease; height: 100%; }
  .quick-tile:hover { transform: translateY(-3px); box-shadow: 0 20px 48px rgba(0,0,0,0.34); border-color: rgba(96,165,250,0.35); }
  .quick-tile.disabled { opacity: 0.7; cursor: not-allowed; }
  .ai-output { border-top: 1px solid var(--panel-border); background: rgba(255,255,255,0.02); padding: 1rem; border-radius: 0 0 18px 18px; }
  .badge.bg-soft { border: 1px solid var(--panel-border); border-radius: 12px; }
  .hero-meta .btn { transition: transform 0.15s ease, box-shadow 0.15s ease; }
  .hero-meta .btn:hover { transform: translateY(-1px); box-shadow: 0 12px 26px rgba(0,0,0,0.28); }
  .pill-muted { border: 1px solid var(--panel-border); border-radius: 12px; background: rgba(255,255,255,0.05); padding: 0.45rem 0.75rem; display: inline-flex; align-items: center; gap: 0.4rem; }
  .icon-circle { background: rgba(255,255,255,0.06); box-shadow: inset 0 1px 0 rgba(255,255,255,0.05); }
  .avatar-brand img { border-radius: 10px; }
  .btn { transition: transform 0.15s ease, box-shadow 0.15s ease; }
  .btn:hover { transform: translateY(-1px); box-shadow: 0 10px 24px rgba(0,0,0,0.28); }
  @media (max-width: 992px) { .dashboard-hero { padding: 1rem; } }
</style>
{% endblock %}
{% block content %}
<section class="dashboard-shell py-5">
  <div class="floating-grid"></div>
  <div class="container">
    <div class="row g-4 align-items-stretch">
      <div class="col-12">
        <div class="card dashboard-hero shadow-lg border-0" style="--brand: {{ brand_color() }};">
          <div class="card-body d-flex flex-column flex-lg-row justify-content-between align-items-start gap-4">
            <div class="d-flex align-items-center gap-3">
              <div class="avatar-brand" style="background: linear-gradient(135deg, var(--brand), #0ea5e9);">
                {% if org_logo_url() %}
                  <img src="{{ org_logo_url() }}" alt="{{ current_org.name }} logo" class="img-fluid">
                {% else %}
                  <span class="fw-bold text-white text-uppercase">{{ current_org.name[:2] }}</span>
                {% endif %}
              </div>
              <div>
                <p class="text-uppercase text-white small mb-1">Workspace</p>
                <h4 class="fw-bold text-white mb-1">Welcome back, {{ current_user.full_name.split(' ')[0] }} â€” {{ current_org.name }} Workspace</h4>
                <div class="text-secondary">{{ current_org.tagline or "Secure, tenant-isolated experience" }}</div>
                <div class="mt-2 d-flex gap-2 flex-wrap">
                  <span class="badge bg-soft">{{ current_user.role.value|title }} role</span>
                  <span class="badge bg-soft">Org slug: {{ current_org.slug }}</span>
                  <span class="badge bg-soft">Brand: {{ brand_color() }}</span>
                </div>
              </div>
            </div>
            <div class="hero-meta text-lg-end w-100 w-lg-auto">
              <div class="pill-muted mb-2"><i class="bi bi-shield-lock text-success"></i> Tenant isolation enforced</div>
              {% if is_admin() %}
                <a href="{{ url_for('main.organization_profile') }}" class="btn btn-light btn-sm shadow-sm me-2"><i class="bi bi-building"></i> Organization profile</a>
                <a href="{{ url_for('main.team_management') }}" class="btn btn-outline-light btn-sm shadow-sm"><i class="bi bi-people"></i> Manage users</a>
              {% else %}
                <a href="{{ url_for('main.onboarding') }}" class="btn btn-light btn-sm shadow-sm"><i class="bi bi-rocket"></i> Complete onboarding</a>
              {% endif %}
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="row g-3 stats-grid">
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-uppercase text-white small mb-1">Total users</p>
                  <div class="stat-number">{{ data.stats.total_users }}</div>
                  <div class="text-secondary small">Across your tenant</div>
                </div>
                <div class="icon-circle text-primary"><i class="bi bi-people"></i></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-uppercase text-white small mb-1">Active users</p>
                  <div class="stat-number text-success">{{ data.stats.active_users }}</div>
                  <div class="text-secondary small">Ready to access</div>
                </div>
                <div class="icon-circle text-success"><i class="bi bi-activity"></i></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-uppercase text-white small mb-1">Disabled / Pending</p>
                  <div class="stat-number text-warning">{{ data.stats.inactive_users }}</div>
                  <div class="text-secondary small">Requires admin attention</div>
                </div>
                <div class="icon-circle text-warning"><i class="bi bi-pause-circle"></i></div>
              </div>
            </div>
          </div>
          <div class="col-12 col-sm-6 col-xl-3">
            <div class="stat-card">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <p class="text-uppercase text-white small mb-1">Admins</p>
                  <div class="stat-number">{{ data.stats.admin_users }}</div>
                  <div class="text-secondary small">Guarding the workspace</div>
                </div>
                <div class="icon-circle text-info"><i class="bi bi-key"></i></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12">
        <div class="card ai-card shadow-sm">
          <div class="card-body d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
            <div>
              <p class="text-uppercase text-white small mb-1">AI Recommendation</p>
              <h6 class="fw-bold text-white mb-1">Dashboard smart insight</h6>
              <div class="text-secondary small">Gemini summarizes tenant health with prioritized actions.</div>
            </div>
            <form method="post" action="{{ url_for('main.dashboard_ai_insight') }}" class="d-flex align-items-center gap-2 ai-action-form" data-disable-on-submit="true">
              <button class="btn btn-primary btn-sm" type="submit" data-loading-text="Generating..." aria-busy="false"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span><i class="bi bi-stars"></i> <span>Generate AI Insight</span></button>
            </form>
          </div>
          <div class="ai-output {{ 'error' if ai_dashboard_error else '' }}">
            {% if ai_dashboard_insight %}
              {{ ai_dashboard_insight | safe }}
            {% elif ai_dashboard_error %}
              <span class="text-danger">AI insight is unavailable right now. Please try again.</span>
            {% else %}
              <span class="text-secondary">Click "Generate AI Insight" to get a tailored summary for your organization.</span>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-8">
        <div class="card chart-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <p class="text-uppercase text-white small mb-1">User growth</p>
                <h5 class="fw-bold text-white mb-0">Member adoption over time</h5>
              </div>
              <span class="badge bg-soft">Org age: {{ data.stats.org_age_days }} days</span>
            </div>
            <div class="chart-shell">
              {% set growth_empty = data.charts.user_growth|length == 0 %}
              {% if growth_empty %}
                <div class="empty-chart">No teammates yet. Invite your first member to see growth.</div>
              {% endif %}
              <canvas id="userGrowthChart" class="{{ 'd-none' if growth_empty else '' }}" height="240"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-lg-4">
        <div class="card h-100 chart-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <p class="text-uppercase text-white small mb-1">Roles</p>
                <h6 class="fw-bold text-white mb-0">Distribution</h6>
              </div>
              <span class="badge bg-soft">Admin vs Standard</span>
            </div>
            {% set role_empty = data.charts.role_distribution|length == 0 %}
            <div class="chart-shell">
              {% if role_empty %}
                <div class="empty-chart">Roles appear after you add users.</div>
              {% endif %}
              <canvas id="roleDistributionChart" class="{{ 'd-none' if role_empty else '' }}" height="220"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-6">
        <div class="card chart-card h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-3">
              <div>
                <p class="text-uppercase text-white small mb-1">Login activity</p>
                <h6 class="fw-bold text-white mb-0">Past 30 days</h6>
              </div>
              <span class="badge bg-soft">Security pulse</span>
            </div>
            {% set login_empty = data.charts.login_activity|length == 0 %}
            <div class="chart-shell">
              {% if login_empty %}
                <div class="empty-chart">No logins recorded yet. Activity appears after members sign in.</div>
              {% endif %}
              <canvas id="loginActivityChart" class="{{ 'd-none' if login_empty else '' }}" height="240"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="col-12 col-xl-6">
        <div class="row g-3 h-100">
          <div class="col-12">
            <div class="card h-100 mini-card">
              <div class="card-body d-flex align-items-center justify-content-between gap-3">
                <div>
                  <p class="text-uppercase text-white small mb-1">Identity</p>
                  <h6 class="fw-bold text-white mb-1">Brand snapshot</h6>
                  <div class="text-secondary small">{{ current_org.contact_email }}</div>
                  <div class="text-secondary small">{{ current_org.description or "Tell your story with a rich description in Organization Profile." }}</div>
                </div>
                <div class="avatar-brand" style="background: {{ brand_color() }};">
                  {% if org_logo_url() %}
                    <img src="{{ org_logo_url() }}" alt="Logo" class="img-fluid">
                  {% else %}
                    <i class="bi bi-gem text-white"></i>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mini-card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="fw-bold text-white mb-0">Last login</h6>
                  <i class="bi bi-clock-history text-info"></i>
                </div>
                {% if data.stats.last_login_at %}
                  <div class="fw-semibold text-white">{{ data.stats.last_login_user }}</div>
                  <div class="text-secondary small">{{ data.stats.last_login_display }}</div>
                {% else %}
                  <div class="text-secondary small">No logins recorded yet.</div>
                {% endif %}
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="card mini-card h-100">
              <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                  <h6 class="fw-bold text-white mb-0">Security posture</h6>
                  <i class="bi bi-shield-check text-success"></i>
                </div>
                <ul class="list-unstyled mb-0 small text-secondary">
                  <li class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-check2-circle text-success"></i>Tenant isolation enforced per session</li>
                  <li class="d-flex align-items-center gap-2 mb-1"><i class="bi bi-check2-circle text-success"></i>Role-based access for admin features</li>
                  <li class="d-flex align-items-center gap-2"><i class="bi bi-check2-circle text-success"></i>Admins guard org identity updates</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
      </div>

      {% if is_admin() %}
      <div class="col-12">
        <div class="card shadow-sm admin-quick h-100">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <p class="text-uppercase text-white small mb-1">Admin controls</p>
                <h6 class="fw-bold text-white mb-0">Operate your workspace</h6>
              </div>
              <span class="badge bg-soft text-success"><i class="bi bi-shield-lock"></i> Admin only</span>
            </div>
            <div class="row g-3">
              <div class="col-md-4">
                <a class="quick-tile" href="{{ url_for('main.team_management') }}">
                  <div class="icon-circle text-primary"><i class="bi bi-people"></i></div>
                  <div class="fw-semibold text-white">Manage users</div>
                  <div class="text-secondary small">Invite, disable, and assign roles.</div>
                </a>
              </div>
              <div class="col-md-4">
                <a class="quick-tile" href="{{ url_for('main.organization_profile') }}">
                  <div class="icon-circle text-warning"><i class="bi bi-brush"></i></div>
                  <div class="fw-semibold text-white">Organization profile</div>
                  <div class="text-secondary small">Brand color, logo, contact identity.</div>
                </a>
              </div>
              <div class="col-md-4">
                <div class="quick-tile disabled">
                  <div class="icon-circle text-secondary"><i class="bi bi-gear"></i></div>
                  <div class="fw-semibold text-white">Bulk actions</div>
                  <div class="text-secondary small">Coming soon for bulk offboarding.</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</section>
{% endblock %}

{% block extra_scripts %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <script>
    const dashboardData = {{ dashboard_data | tojson }};

    const brandColor = dashboardData.org.brand_color || '#2563eb';
    const neutralInk = '#94a3b8';

    const buildGradient = (ctx) => {
      const gradient = ctx.createLinearGradient(0, 0, 0, 280);
      gradient.addColorStop(0, brandColor + '99');
      gradient.addColorStop(1, brandColor + '00');
      return gradient;
    };

    const lineDefaults = {
      tension: 0.35,
      borderWidth: 3,
      pointRadius: 4,
      pointHoverRadius: 6,
    };

    const growthData = dashboardData.charts.user_growth || [];
    if (growthData.length) {
      const ctx = document.getElementById('userGrowthChart').getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: growthData.map((p) => p.label),
          datasets: [
            {
              label: 'Users',
              data: growthData.map((p) => p.value),
              borderColor: brandColor,
              backgroundColor: buildGradient(ctx),
              fill: true,
              ...lineDefaults,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false },
          },
          scales: {
            x: { ticks: { color: neutralInk } },
            y: { ticks: { color: neutralInk }, beginAtZero: true },
          },
        },
      });
    }

    const roleData = dashboardData.charts.role_distribution || [];
    if (roleData.length) {
      const ctx = document.getElementById('roleDistributionChart').getContext('2d');
      new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: roleData.map((r) => r.role === 'admin' ? 'Admin' : 'Standard'),
          datasets: [
            {
              data: roleData.map((r) => r.count),
              backgroundColor: [brandColor, '#22c55e'],
              borderWidth: 0,
            },
          ],
        },
        options: {
          cutout: '65%',
          plugins: {
            legend: { position: 'bottom', labels: { color: neutralInk } },
          },
        },
      });
    }

    const loginData = dashboardData.charts.login_activity || [];
    if (loginData.length) {
      const ctx = document.getElementById('loginActivityChart').getContext('2d');
      new Chart(ctx, {
        type: 'bar',
        data: {
          labels: loginData.map((r) => r.label),
          datasets: [
            {
              label: 'Logins',
              data: loginData.map((r) => r.value),
              backgroundColor: brandColor,
              borderRadius: 8,
              maxBarThickness: 22,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { mode: 'index', intersect: false },
          },
          scales: {
            x: { ticks: { color: neutralInk } },
            y: { ticks: { color: neutralInk }, beginAtZero: true },
          },
        },
      });
    }
  </script>
{% endblock %}
